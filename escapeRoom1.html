<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Escape Room JS ‚Äì Fabularny</title>
    <style>
      body {
        font-family: "Courier New", monospace;
        background-color: #0b0b0b;
        color: #eee;
	max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }
      h1 {
        text-align: center;
        color: #0ff;
      }
      .task {
        border: 2px solid #444;
        padding: 15px;
        margin: 15px 0;
        background-color: #1a1a1a;
      }
      .task.locked {
        display: none;
      }
      textarea {
        width: 100%;
        min-height: 150px;
        padding: 10px;
        margin-top: 10px;
        background-color: #0b0b0b;
        color: #0ff;
        border: 1px solid #444;
        font-family: "Courier New", monospace;
        font-size: 14px;
        resize: vertical;
      }
      input,
      button {
        padding: 8px;
        margin-top: 10px;
      }
      button {
        background-color: #0ff;
        color: #000;
        border: none;
        cursor: pointer;
        font-weight: bold;
        padding: 10px 20px;
      }
      button:hover {
        background-color: #0cc;
      }
      .hint {
        color: #ff0;
        margin-top: 10px;
        display: none;
      }
      .instructions {
        background-color: #1a3a1a;
        border: 2px solid #0f0;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
      }
      .instructions h2 {
        color: #0f0;
        margin-top: 0;
        font-size: 18px;
      }
      .instructions ul {
        margin: 10px 0;
        padding-left: 25px;
      }
      .instructions li {
        margin: 5px 0;
        color: #eee;
      }
      .instructions code {
        color: #0ff;
        background-color: #0b0b0b;
        padding: 2px 5px;
        border-radius: 3px;
      }
      .success {
        color: #0f0;
        font-weight: bold;
      }
      .fail {
        color: #f33;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Escape Room ‚Äì Misja Informatyka</h1>
    <div class="instructions">
      <h2>üìã Instrukcje wprowadzania kodu:</h2>
      <ul>
        <li>Wpisz kod JavaScript, kt√≥ry oblicza i zwraca wynik</li>
        <li>
          Mo≈ºesz u≈ºyƒá deklaracji zmiennych (<code>let</code>,
          <code>const</code>)
        </li>
        <li>
          Ostatnia linia powinna byƒá wyra≈ºeniem zwracajƒÖcym wynik (bez ≈õrednika)
          lub u≈ºyj <code>return</code>
        </li>
        <li>
          Przyk≈Çad poprawnego kodu:<br />
          <code style="display: block; margin-top: 5px; padding: 10px">
            let a = 5;<br />
            let b = 3;<br />
            a * b + 2
          </code>
        </li>
        <li>Zmienne z poprzednich zada≈Ñ sƒÖ dostƒôpne automatycznie</li>
      </ul>
    </div>
    <div id="tasks"></div>

    <script>
      const tasks = [
        {
          question:
            "1. Budzisz siƒô w ciemnym pokoju. Na ≈õcianie widzisz tajemnicze liczby: 6 i 3. Musisz je pomno≈ºyƒá przez siebie, a nastƒôpnie dodaƒá 2. Jaki jest wynik tego obliczenia?",
          answer: "20",
          hint: "Przyk≈Çadowy kod: let a = 5; let b = 4; a * b + 1",
        },
        {
          question:
            "2. Drzwi siƒô uchylajƒÖ, ale pojawia siƒô stra≈ºnik. Pyta: czy poprzedni wynik powiƒôkszony o 5 przekracza 22? Odpowiedz true lub false.",
          answer: "true",
          hint: "Przyk≈Çadowy kod: let wynik = 15; wynik + 3 > 18",
        },
        {
          question:
            "3. Stra≈ºnik pyta o has≈Ço. Je≈õli poprzednia odpowied≈∫ by≈Ça true, has≈Ço to 'otwarte', w przeciwnym razie 'zamkniƒôte'. Jaka jest warto≈õƒá has≈Ça?",
          answer: "otwarte",
          hint: "Przyk≈Çadowy kod: let odpowiedz = true; let haslo; if (odpowiedz) { haslo = 'tak'; } else { haslo = 'nie'; }",
        },
        {
          question:
            "4. W kolejnym pokoju znajduje siƒô skrzynia. Aby jƒÖ otworzyƒá, musisz pomno≈ºyƒá poprzedni wynik (20) przez 2, a nastƒôpnie odjƒÖƒá 12. Jaki jest wynik?",
          answer: "28",
          hint: "Przyk≈Çadowy kod: let x = 15; x * 2 - 2",
        },
        {
          question:
            "5. Skrzynia siƒô otwiera, ale w ≈õrodku jest pu≈Çapka. Sprawd≈∫ czy warto≈õƒá klucza jest liczbƒÖ parzystƒÖ. Odpowiedz true lub false.",
          answer: "true",
          hint: "Przyk≈Çadowy kod: let liczba = 10; liczba % 2 === 0",
        },
        {
          question:
            "6. Pu≈Çapka zadaje pytanie: je≈õli klucz jest mniejszy ni≈º 30, odpowied≈∫ to 'bezpiecznie'. W przeciwnym razie 'niebezpiecze≈Ñstwo'. Jaka jest odpowied≈∫?",
          answer: "bezpiecznie",
          hint: "Przyk≈Çadowy kod: let x = 15; let wynik; if (x < 20) { wynik = 'malo'; } else { wynik = 'duzo'; }",
        },
        {
          question:
            "7. Widzisz sejf. Aby go otworzyƒá, musisz dodaƒá warto≈õƒá klucza do liczby 3. Jaki jest wynik tego dodawania?",
          answer: "31",
          hint: "Przyk≈Çadowy kod: let a = 10; let b = 5; a + b",
        },
        {
          question:
            "8. Sejf zawiera ostatnie drzwi. Sprawd≈∫ resztƒô z dzielenia kodu przez 2. Je≈õli reszta wynosi 1, odpowied≈∫ to 'wyj≈õcie', w przeciwnym razie 'pu≈Çapka'. Jaka jest odpowied≈∫?",
          answer: "wyj≈õcie",
          hint: "Przyk≈Çadowy kod: let x = 7; let wynik; if (x % 2 === 1) { wynik = 'nieparzyste'; } else { wynik = 'parzyste'; }",
        },
      ];

      const container = document.getElementById("tasks");

      tasks.forEach((task, index) => {
        const div = document.createElement("div");
        div.className = "task locked";
        div.innerHTML = `
        <p>${task.question}</p>
        <textarea id="input${index}" placeholder="Wpisz kod JavaScript tutaj...&#10;Przyk≈Çad:&#10;let a = 5;&#10;let b = 3;&#10;a * b + 2"></textarea>
        <button onclick="checkAnswer(${index})">Sprawd≈∫ kod</button>
        <p id="result${index}"></p>
        <p class="hint" id="hint${index}">üí° Podpowied≈∫ - przyk≈Çadowy kod podobny do rozwiƒÖzania:<br><code style="color: #0ff; background-color: #0b0b0b; padding: 5px; display: block; margin-top: 5px;">${task.hint}</code></p>
      `;
        container.appendChild(div);
      });

      let attempts = Array(tasks.length).fill(0);
      // Wsp√≥lny zakres zmiennych dla wszystkich zada≈Ñ
      const sharedScope = {};

      function checkAnswer(i) {
        const codeInput = document.getElementById("input" + i).value.trim();
        const result = document.getElementById("result" + i);

        if (!codeInput) {
          result.textContent = "‚ùå Wprowad≈∫ kod JavaScript.";
          result.className = "fail";
          return;
        }

        try {
          // Wykonaj kod u≈ºytkownika z dostƒôpem do zmiennych z poprzednich zada≈Ñ
          const userCode = codeInput;
          let executionResult;

          // Znajd≈∫ zmienne zadeklarowane w kodzie u≈ºytkownika, aby uniknƒÖƒá konflikt√≥w
          const userDeclaredVars = new Set();
          const varDeclPattern = /(?:let|const|var)\s+(\w+)/g;
          let match;
          while ((match = varDeclPattern.exec(userCode)) !== null) {
            userDeclaredVars.add(match[1]);
          }

          // Przygotuj kod z dostƒôpem do zmiennych z poprzednich zada≈Ñ
          // U≈ºywamy var zamiast let, aby uniknƒÖƒá b≈Çƒôd√≥w redeklaracji
          // Pomijamy zmienne, kt√≥re u≈ºytkownik ju≈º zadeklarowa≈Ç w swoim kodzie
          const setupCode = Object.keys(sharedScope)
            .filter((key) => !userDeclaredVars.has(key))
            .map((key) => {
              const value = sharedScope[key];
              // Obs≈Çuga r√≥≈ºnych typ√≥w warto≈õci
              if (typeof value === "string") {
                return `var ${key} = ${JSON.stringify(value)};`;
              } else if (
                typeof value === "number" ||
                typeof value === "boolean"
              ) {
                return `var ${key} = ${value};`;
              } else {
                return `var ${key} = ${JSON.stringify(value)};`;
              }
            })
            .join("\n");

          // Sprawdzamy czy kod zawiera return
          if (userCode.includes("return")) {
            // Je≈õli zawiera return, wykonujemy jako funkcjƒô
            const func = new Function(setupCode + "\n" + userCode);
            executionResult = func();
          } else {
            // W przeciwnym razie wykonujemy kod i pr√≥bujemy zwr√≥ciƒá ostatniƒÖ warto≈õƒá
            const lines = userCode
              .split("\n")
              .map((line) => line.trim())
              .filter((line) => line);

            if (lines.length === 0) {
              throw new Error("Kod jest pusty.");
            }

            const lastLine = lines[lines.length - 1];
            const isLastLineExpression =
              !lastLine.includes("=") && !lastLine.endsWith(";");

            if (isLastLineExpression) {
              // Ostatnia linia to wyra≈ºenie - wykonujemy kod przed niƒÖ i zwracamy wynik wyra≈ºenia
              const codeBeforeLast = lines.slice(0, -1).join("\n");
              const fullCode =
                setupCode + "\n" + codeBeforeLast + "\n" + "return " + lastLine;
              executionResult = new Function(fullCode)();
            } else {
              // Kod ko≈Ñczy siƒô ≈õrednikiem lub przypisaniem
              // Wykonujemy kod i pr√≥bujemy znale≈∫ƒá wynik
              if (lastLine.includes("=")) {
                // Ostatnia linia to przypisanie - wykonujemy kod i zwracamy przypisanƒÖ warto≈õƒá
                const varName = lastLine
                  .split("=")[0]
                  .trim()
                  .replace(/let|const|var/g, "")
                  .trim();
                const fullCode =
                  setupCode + "\n" + userCode + "\n" + `return ${varName};`;
                executionResult = new Function(fullCode)();

                // Zapisz zmiennƒÖ do wsp√≥lnego zakresu
                sharedScope[varName] = executionResult;
              } else {
                throw new Error(
                  "Kod powinien zwracaƒá warto≈õƒá. U≈ºyj wyra≈ºenia jako ostatniej linii (bez ≈õrednika) lub 'return'."
                );
              }
            }
          }

          // Zapisz zmienne zadeklarowane w kodzie do wsp√≥lnego zakresu
          const varPattern = /(?:let|const|var)\s+(\w+)\s*=\s*([^;]+)/g;
          let varMatch;
          while ((varMatch = varPattern.exec(userCode)) !== null) {
            try {
              const varName = varMatch[1];
              const varExpression = varMatch[2].trim();
              // Wykonaj wyra≈ºenie przypisania w kontek≈õcie z dostƒôpem do zmiennych
              const getValue = new Function(
                setupCode + "\n" + `return ${varExpression};`
              );
              sharedScope[varName] = getValue();
            } catch (e) {
              // Ignoruj b≈Çƒôdy przy zapisywaniu zmiennych
            }
          }

          // Konwertuj wynik na string dla por√≥wnania
          const resultString = String(executionResult);
          const expectedAnswer = String(tasks[i].answer);

          // Sprawd≈∫ czy wynik pasuje do oczekiwanej odpowiedzi
          if (resultString === expectedAnswer) {
            result.textContent =
              "‚úÖ Poprawna odpowied≈∫! Kod dzia≈Ça prawid≈Çowo.";
            result.className = "success";
            document.querySelectorAll(".task")[i].classList.remove("locked");
            if (i + 1 < tasks.length) {
              document
                .querySelectorAll(".task")
                [i + 1].classList.remove("locked");
            } else {
              alert("Gratulacje! Uciek≈Çe≈õ z Escape Roomu üéâ");
            }
          } else {
            attempts[i]++;
            result.textContent = `‚ùå Niepoprawny wynik. Otrzymano: ${resultString}, oczekiwano: ${expectedAnswer}`;
            result.className = "fail";
            if (attempts[i] >= 3) {
              document.getElementById("hint" + i).style.display = "block";
            }
          }
        } catch (error) {
          attempts[i]++;
          result.textContent = `‚ùå B≈ÇƒÖd w kodzie: ${error.message}`;
          result.className = "fail";
          if (attempts[i] >= 3) {
            document.getElementById("hint" + i).style.display = "block";
          }
        }
      }

      // Odblokuj pierwsze zadanie na start
      document.querySelectorAll(".task")[0].classList.remove("locked");
    </script>
  </body>
</html>